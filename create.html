<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge Editor | GDevelop Style</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-editor: #1a1a24;
            --bg-sidebar: #15151e;
            --border: #2d2d3d;
            --accent: #6366f1;
            --canvas-bg: #000000;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg-editor); color: white; font-family: 'Segoe UI', sans-serif; }

        /* Toolbar */
        .toolbar {
            height: 50px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .toolbar-brand { font-weight: 800; font-size: 1.2rem; color: white; text-decoration: none; }
        .toolbar-brand span { color: var(--accent); }
        .tool-btns { display: flex; gap: 10px; }

        /* Editor Main Layout */
        .editor-container { display: flex; height: calc(100vh - 50px); }

        /* Sidebars */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .right-sidebar { border-right: none; border-left: 1px solid var(--border); }
        .panel-header { background: #22222f; padding: 8px 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: #888; border-bottom: 1px solid var(--border); }

        /* Objects Library */
        .object-list { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .obj-item {
            background: #2d2d3d; border: 1px solid transparent; border-radius: 6px; padding: 15px;
            text-align: center; cursor: grab; transition: 0.2s; font-size: 0.8rem;
        }
        .obj-item:hover { border-color: var(--accent); background: #35354a; }
        .obj-item i { display: block; font-size: 1.5rem; margin-bottom: 8px; color: var(--accent); }

        /* Canvas Area */
        .canvas-area {
            flex: 1; background: #111; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: auto;
            background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px;
        }
        canvas { background: var(--canvas-bg); box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 1px solid #333; }

        /* Properties Panel */
        .prop-item { padding: 12px; border-bottom: 1px solid #222; font-size: 0.85rem; }
        .prop-item label { display: block; color: #666; margin-bottom: 5px; font-size: 0.7rem; }
        .prop-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 5px; border-radius: 4px; }

        .btn-small { padding: 6px 15px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-dark { background: #2d2d3d; color: white; }
    </style>
</head>
<body>

    <div class="toolbar">
        <a href="index.html" class="toolbar-brand">Play<span>Forge</span></a>
        <div style="display: flex; gap: 20px; font-size: 0.8rem; color: #666;">
            <span>File</span><span>Edit</span><span>Project</span><span>Scene</span>
        </div>
        <div class="tool-btns">
            <button class="btn-small btn-dark"><i class="fas fa-play"></i> Preview</button>
            <button class="btn-small btn-accent" onclick="saveToCloud()"><i class="fas fa-cloud-upload-alt"></i> Publish</button>
        </div>
    </div>

    <div class="editor-container">
        <aside class="sidebar">
            <div class="panel-header">Scene Manager</div>
            <div style="padding: 10px;">
                <div style="color: var(--accent); background: #2d2d3d33; padding: 8px; border-radius: 4px; font-size: 0.85rem;">
                    <i class="fas fa-layer-group"></i> Main Scene
                </div>
            </div>
            <div class="panel-header" style="margin-top: auto;">Layers</div>
            <div style="padding: 10px; font-size: 0.8rem; color: #666;">Base Layer</div>
        </aside>

        <main class="canvas-area">
            <canvas id="editorCanvas" width="800" height="450"></canvas>
        </main>

        <aside class="sidebar right-sidebar">
            <div class="panel-header">Object Library</div>
            <div class="object-list">
                <div class="obj-item" draggable="true" ondragstart="onDragStart(event)" id="sprite">
                    <i class="fas fa-ghost"></i> Sprite
                </div>
                <div class="obj-item" draggable="true" ondragstart="onDragStart(event)" id="platform">
                    <i class="fas fa-cube"></i> Platform
                </div>
                <div class="obj-item" draggable="true" ondragstart="onDragStart(event)" id="enemy">
                    <i class="fas fa-skull"></i> Enemy
                </div>
                <div class="obj-item" draggable="true" ondragstart="onDragStart(event)" id="text">
                    <i class="fas fa-font"></i> Text
                </div>
            </div>

            <div class="panel-header">Properties</div>
            <div id="propertyPanel" class="properties-panel">
                <div style="padding: 20px; color: #444; text-align: center; font-size: 0.8rem;">
                    Select an object on the canvas to edit its properties.
                </div>
            </div>
        </aside>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        let gameObjects = [];
        let selectedObj = null;
        const GRID_SIZE = 20;

        // 1. Drag and Drop Logic
        function onDragStart(ev) {
            ev.dataTransfer.setData("type", ev.target.id);
        }

        canvas.addEventListener('dragover', (e) => e.preventDefault());

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData("type");
            const rect = canvas.getBoundingClientRect();
            
            // Snap to Grid calculation
            const rawX = e.clientX - rect.left - 20;
            const rawY = e.clientY - rect.top - 20;
            const x = Math.round(rawX / GRID_SIZE) * GRID_SIZE;
            const y = Math.round(rawY / GRID_SIZE) * GRID_SIZE;

            const newObj = {
                id: Date.now(),
                type: type,
                x: x, y: y,
                w: 40, h: 40,
                name: type + "_" + (gameObjects.length + 1),
                color: type === 'enemy' ? '#ef4444' : (type === 'platform' ? '#3b82f6' : '#6366f1')
            };

            gameObjects.push(newObj);
            selectedObj = newObj;
            render();
            updatePropertyPanel();
        });

        // 2. Rendering
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Objects
            gameObjects.forEach(obj => {
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);

                // Highlight Selected
                if (selectedObj && obj.id === selectedObj.id) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obj.x - 2, obj.y - 2, obj.w + 4, obj.h + 4);
                }
            });
        }

        // 3. Selection Logic
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            selectedObj = gameObjects.find(obj => 
                mouseX >= obj.x && mouseX <= obj.x + obj.w &&
                mouseY >= obj.y && mouseY <= obj.y + obj.h
            );

            updatePropertyPanel();
            render();
        });

        // 4. Property Panel Update
        function updatePropertyPanel() {
            const panel = document.getElementById('propertyPanel');
            if (!selectedObj) {
                panel.innerHTML = `<div style="padding: 20px; color: #444; text-align: center; font-size: 0.8rem;">Select an object...</div>`;
                return;
            }

            panel.innerHTML = `
                <div class="prop-item">
                    <label>Object Name</label>
                    <input type="text" class="prop-input" value="${selectedObj.name}" onchange="updateSelected('name', this.value)">
                </div>
                <div class="prop-item">
                    <label>Position X</label>
                    <input type="number" class="prop-input" value="${selectedObj.x}" onchange="updateSelected('x', parseInt(this.value))">
                </div>
                <div class="prop-item">
                    <label>Position Y</label>
                    <input type="number" class="prop-input" value="${selectedObj.y}" onchange="updateSelected('y', parseInt(this.value))">
                </div>
                <div style="padding:15px;">
                    <button class="btn-small btn-dark" style="width:100%; background:#7f1d1d;" onclick="deleteSelected()">Delete Object</button>
                </div>
            `;
        }

        function updateSelected(prop, value) {
            if (selectedObj) {
                selectedObj[prop] = value;
                render();
            }
        }

        function deleteSelected() {
            gameObjects = gameObjects.filter(o => o.id !== selectedObj.id);
            selectedObj = null;
            updatePropertyPanel();
            render();
        }

        // 5. Cloud Save Logic
        async function saveToCloud() {
            if(gameObjects.length === 0) return alert("Nothing to publish!");
            const title = prompt("Enter Game Title:");
            if(!title) return;

            try {
                await db.collection('games').add({
                    title: title,
                    data: gameObjects,
                    views: 0,
                    devId: auth.currentUser ? auth.currentUser.uid : 'guest',
                    createdAt: new Date()
                });
                alert("Published Successfully to PlayForge!");
                window.location.href = "dashboard.html";
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        render();
    </script>
</body>
</html>
